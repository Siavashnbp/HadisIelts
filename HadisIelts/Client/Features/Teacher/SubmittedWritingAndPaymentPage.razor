@page "/teacher/services/writingCorrection/submittedFiles/{PaymentID}"
@using HadisIelts.Client.Features.Correction.WritingCorrectionComponents
@using HadisIelts.Client.Features.Teacher.SubmittedWritingAndPaymentComponents
@using HadisIelts.Client.Services.Writing;
@using HadisIelts.Shared.Requests.Payment;
@using System.Net;
@inject IClientWritingServices ClientWritingSevices;
@inject IMediator Mediator;
<AuthorizeView>
    <Authorized>
        <div class="container" style="margin-top:10px;">
            @if (_paymentGroup is not null && _paymentGroup.Service is not null)
            {
                <div class="row">
                    <div class="col">
                        <ProcessedWritingFilesTable ProcessedFiles="_paymentGroup.Service.ProcessedWritingFiles" />
                    </div>
                </div>
                <div class="row justify-content-center text-center">
                    <div class="col">
                        <h5 class="text-success">Total Price : @($"{_paymentGroup.Service.TotalPrice:n0}") Rials</h5>
                    </div>
                </div>
            }

            <div class="row">
                @if (_paymentFiles is not null && _paymentFiles.Count > 0)
                {
                    <div class="accordion" id="accordionSubmittedPayments">
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="submittedPaymentHeader">
                                <button class="accordion-button" type="button" data-bs-toggle="collapse"
                                        data-bs-target="#submittedPaymentCollapse" aria-expanded="false"
                                        aria-controls="submittedPaymentCollapse">
                                    Submitted Payments
                                </button>
                            </h2>
                            <div id="submittedPaymentCollapse" class="accordion-collapse collapse show" aria-labelledby="submittedPaymentHeader"
                                 data-bs-parent="#accordionSubmittedPayment">
                                <div class="accordion-body">
                                    <div class="row">

                                        @foreach (var item in _paymentFiles)
                                        {
                                            <div class="col-lg-4">
                                                <PaymentVerificationImageCard PaymentFile="item" OnThumbnailIsClicked="HandleOnThumbnailIsClicked"
                                                                      OnVerificationButtonIsClicked="HandleOnVerificationButtonIsClicked" />
                                            </div>
                                        }
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                }
            </div>
        </div>
    </Authorized>
</AuthorizeView>
@code {
    [Parameter]
    public string? PaymentID { get; set; }
    private PaymentGroupSharedModel<WritingCorrectionPackageSharedModel> _paymentGroup = new PaymentGroupSharedModel<WritingCorrectionPackageSharedModel>();
    private List<PaymentPictureSharedModel> _paymentFiles = new List<PaymentPictureSharedModel>();
    private string? _modalImageData;
    private bool _showModal = false;
    protected override async Task OnInitializedAsync()
    {
        await GetWritingCorrectionPaymentPackage();
        if (_paymentGroup is not null)
        {
            _paymentGroup.Service = new WritingCorrectionPackageSharedModel();
            var result = await ClientWritingSevices.GetSubmittedWritingCorrectionFiles(_paymentGroup.SubmittedServiceID);
            _paymentGroup.Message = result.Message;
            _paymentGroup.Service.TotalPrice = result.WritingCorrectionPackage.TotalPrice;
            _paymentGroup.Service.ProcessedWritingFiles = new List<ProcessedWritingFileSharedModel>();
            _paymentGroup.Service.ProcessedWritingFiles = result.WritingCorrectionPackage.ProcessedWritingFiles;
        }
    }
    private async Task GetWritingCorrectionPaymentPackage()
    {
        if (PaymentID is not null)
        {
            _paymentGroup = new PaymentGroupSharedModel<WritingCorrectionPackageSharedModel>();
            var request = new GetPaymentGroupRequest(PaymentID);
            var result = await Mediator.Send(request);
            _paymentGroup = result.PaymentGroup;
            _paymentFiles = _paymentGroup.PaymentPictures;
        }
    }
    //Handlers
    private async Task HandleOnThumbnailIsClicked(string data)
    {
        _modalImageData = data;
        _showModal = true;
    }
    private async Task HandleOnVerificationButtonIsClicked((int pictureID, bool isVerified) paymentVerification)
    {
        try
        {
            var request = new PaymentVerificationRequest
            (PaymentID: paymentVerification.pictureID, IsVerfifed: paymentVerification.isVerified);
            var response = await Mediator.Send(request);
            if (response.VerifiedPayment is not null)
            {
                var paymentIndex = _paymentFiles.FindIndex(payment => payment.ID == paymentVerification.pictureID);
                if (paymentIndex != -1)
                {
                    _paymentFiles[paymentIndex] = response.VerifiedPayment;
                }
            }
        }
        catch (Exception)
        {

            throw;
        }
    }
}
